# CRIAR E REMOVER UMA BRIDGE DE REDE COM BRIDGE-UTILS (UBUNTU 25.10 / DEBIAN 13)

## INTRODU√á√ÉO

Este guia explica, de forma pr√°tica e segura, como **criar e remover uma interface de rede do tipo *bridge*** (`br0`) no **Ubuntu 25.10** ou **Debian 13 (Trixie)**.  
O objetivo √© permitir que **m√°quinas virtuais (QEMU/KVM, VirtualBox)** ou **containers** usem a **mesma rede f√≠sica** do computador anfitri√£o, recebendo IP diretamente do **servidor DHCP** da rede local ‚Äî como se fossem dispositivos f√≠sicos conectados ao roteador.

A *bridge* atua como uma ‚Äúponte virtual‚Äù entre a interface de rede f√≠sica (`enp8s0`) e as interfaces virtuais das VMs.  
Assim, todas compartilham o mesmo segmento de rede, facilitando o acesso entre o host e as VMs e permitindo que elas obtenham IPs autom√°ticos, fa√ßam parte do mesmo dom√≠nio e respondam a pings normalmente.

> üí° Este procedimento √© compat√≠vel tanto com ambientes **gr√°ficos (virt-manager)** quanto **servidores headless (libvirt/QEMU puro)**.

Durante o processo:
- A interface f√≠sica (`enp8s0`) ser√° **transferida para a bridge**;
- O **IP passar√° a ser atribu√≠do √† `br0`** (e n√£o mais √† `enp8s0`);
- Voc√™ poder√° **usar DHCP ou IP fixo** (exemplo incluso);
- Um **m√©todo de revers√£o** completo √© apresentado ao final, com op√ß√£o de restaura√ß√£o total do backup.

‚ö†Ô∏è **Importante:**  
Execute este guia **diretamente no terminal local** (n√£o via SSH), pois a conex√£o pode cair temporariamente enquanto a nova bridge √© criada.


## ENTENDENDO O AMBIENTE DO EXEMPLO
O ambiente usado neste guia √© t√≠pico de um sistema limpo com suporte a virtualiza√ß√£o (QEMU/KVM, VirtualBox, etc.).

- Distribui√ß√£o: `Debian 13`
- Gerenciador de rede: NetworkManager (`nmcli`)
- Interface f√≠sica: `enp8s0`
- Nome da conex√£o que aponta para Interface fisica: `Wired connection 1`
- Nome da bridge: `br0`
- Diret√≥rio de backups: `~/net-backups`
- O passo a passo descreve uma bridge que usa IP via DHCP, mas caso opte por IP Fixo, ent√£o o exemplo alternativo usa o IP `192.168.1.50/24`, o gateway ser√° `192.168.1.1` e o DNS da rede ser√° local com o IP `192.168.1.5`.
- Estado do arquivo `/etc/network/interfaces`:
  - Conte√∫do atual:
    ```text
    source /etc/network/interfaces.d/*

    # The loopback network interface
    auto lo
    iface lo inet loopback
    ```
  - Interpreta√ß√£o: Apenas o loopback est√° definido. **N√£o h√° blocos para `enp8s0`**, portanto n√£o existe conflito com o NetworkManager. **Nenhuma altera√ß√£o √© necess√°ria nesse arquivo.**

## INSTALA√á√ÉO
Garante a presen√ßa do NetworkManager, utilit√°rios de bridge e ferramentas de rede:  

```bash
sudo apt update
sudo apt install -y network-manager # provavelmente, j√° instalado
sudo apt install -y bridge-utils dnsmasq-base ovmf isc-dhcp-client iproute2
```

## BACKUP DA CONFIGURA√á√ÉO ORIGINAL
Vamos ser cautelosos e fazer um backup de nossa configura√ß√£o de rede atual, assim se algo der errado, restauramos.  

Escolha uma pasta para guardar o backup dessa configura√ß√£o de rede, minha sugest√£o √© **~/net-backups**, mas voc√™ pode escolher outra:  
```bash
export BKP=~/net-backups
```

Depois criamos a pasta:
```bash
mkdir -p $BKP
```

Depois, vamos definir o nome do arquivo de backup com o seu nome:
```bash
export BKPFILE=$BKP/netcfg-bridge-$(date +%F_%H%M%S).tgz 
```

Depois, geramos um relatorio em formato .txt e usamos o tar para compactar os arquivos de configura√ß√µes atuais no local de destino:  
```bash
nmcli general status >$BKPFILE.txt
nmcli con show  >>$BKPFILE.txt
sudo tar -C / -czf $BKPFILE   etc/network etc/NetworkManager etc/systemd/network
sudo chown -R $USER:$USER $BKP
```
E ent√£o verifique os arquivos que foram gerado:  
```bash
$ ls -lh $BKP/
```
E ver√° algo similar a isso:
```
-rw-r--r-- 1 gsantana gsantana 2,3K out 23 16:57 netcfg-bridge-2025-10-23_165719.tgz
-rw-rw-r-- 1 gsantana gsantana  399 out 23 17:10 netcfg-bridge-2025-10-23_165719.tgz.txt
```
Como p√¥de ver, a composi√ß√£o dos arquivos que foram compactados s√£o apenas alguns arquivos textos pequenos, quase nada em termos de espa√ßo. Tamb√©m criamos uma arquivo `.txt` que armazena os resultados dos comandos que voc√™ viu no inicio desse tutorial e mais tarde ser√° poss√≠vel comparar o antes e o depois. Se voc√™ n√£o v√™ nenhum dos dois arquivos, o `.tgz` e o `.txt` ou est√£o vazios, ent√£o algo deu errado nos passos anteriores e √© melhor revis√°-los e n√£o prosseguir.

## VERIFICA√á√ÉO DO AMBIENTE
Comandos √∫teis de verifica√ß√£o, primeira observamos se `enp8s0` esta presente:
```bash
$ ip -br link | grep -E 'enp|eth'
enp8s0           UP             74:56:3c:f0:18:b4 <BROADCAST,MULTICAST,UP,LOWER_UP> 
```
Depois, execute:
```bash
$ nmcli device status | grep enp8s0
enp8s0  ethernet  conectado               Wired connection 1 
```
Note que acima, est√° descrito tanto a interface fisica `enp8s0` como tamb√©m o nome da conex√£o `Wired connection 1`, fique atento porque voc√™ precisar√° adaptar esses nomes ao seu ambiente que pode ser diferente do meu.  

Ap√≥s a instala√ß√£o e a verifica√ß√£o, certifique-se de que o NetworkManager est√° ativo:
```bash
sudo systemctl enable --now NetworkManager
```
Depois observe o status, execute:
```bash
$ sudo nmcli general status
STATE      CONNECTIVITY  WIFI-HW  WIFI        WWAN-HW  WWAN        METERED          
conectado  completa      missing  habilitado  missing  habilitado  n√£o (adivinhado) 
```
Observe suas conex√µes atuais:
```bash
$ nmcli con show 
NAME                UUID                                  TYPE      DEVICE 
Wired connection 1  aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee  ethernet  enp8s0 
lo                  bbbbbbbb-cccc-dddd-eeee-ffffffffffff  loopback  lo  
```


## CRIANDO A BRIDGE COM O NETWORK-MANAGER (nmcli)
Procedimento recomendado para criar a bridge `br0` e anexar `enp8s0` como escrava, usando DHCP na bridge.

Vamos desativar a conex√£o antiga cujo nome da interface √© `enp8s0` e cuja conex√£o tem o nome de `Wired connection 1` :
```bash
sudo nmcli con down "Wired connection 1"
```

Vamos criar a conex√£o da bridge:
```bash
$ sudo nmcli con add type bridge ifname br0 con-name br0 ipv4.method auto ipv6.method ignore
```
O resultado espera do √©:
```
A conex√£o ‚Äúbr0‚Äù (aa0748de-5a0d-4d45-b908-9e9f2c788465) foi adicionada com sucesso.
```

Vamos vincular a interface f√≠sica `enp8s0` como escrava da bridge:
```bash
sudo nmcli con add type bridge-slave ifname enp8s0 con-name br0-port-enp8s0 master br0
```
O resultado esperado √©:
```
A conex√£o ‚Äúbridge-slave-enp8s0‚Äù (7daddf82-c9cb-4e44-9d26-097e9e9c7604) foi adicionada com sucesso.
```

E depois ativamos a conex√£o:
```bash
sudo nmcli con up br0
```
O resultado esperado √©:
```
Conex√£o ativada com sucesso (controller waiting for ports) (caminho D-Bus ativo: /org/freedesktop/NetworkManager/ActiveConnection/4)
```

Agora, vamos a verifica√ß√£o, o comando abaixo mostrar√° tudo relacionado a `br0`:
```bash
nmcli -p con show br0
```
Use "q" para sair da listagem do comando acima, agora vamos ver o IP da nossa `br0`:
```bash
ip -br a show br0
```
Se o resultado for:
```
br0              DOWN    
```
Ent√£o significa que a bridge br0 existe, mas est√° DOWN, ou seja, a interface foi criada, por√©m ainda n√£o est√° ativa ou n√£o recebeu IP. Ent√£o vamos tentar manualmente dessa vez:
```bash
sudo ip link set br0 up
```
Ser√° que dessa vez esta ativa? Vamos confirmar:
```bash
ip -br a show br0
```
Se estiver ativa (UP), ent√£o vamos ver se √© capaz de conectar-se a outros computadores:
```bash
ping -c3 1.1.1.1 && ping -c3 8.8.8.8
```

5) Ajuste para IP est√°tico (opcional):
```bash
sudo nmcli con modify br0 ipv4.method manual   ipv4.addresses "192.168.1.50/24"   ipv4.gateway "192.168.1.1"   ipv4.dns "192.168.1.5"

sudo nmcli con up br0
```

## VERIFICA√á√ÉO P√ìS-BRIDGE (teste de funcionalidade)
Ap√≥s reiniciar o sistema, confirme que a bridge est√° ativa e funcional:

Vamos listar as conex√µes gerenciadas pelo NetworkManager:
```bash
nmcli con show
```

Vamos verificar o estado da bridge e da interface f√≠sica:
```bash
nmcli device status
```
Sa√≠da esperada:
```
DEVICE   TYPE      STATE      CONNECTION
br0      bridge    conectado  br0
enp8s0   ethernet  conectado  bridge-slave-enp8s0
```

Vamos confirmar a associa√ß√£o f√≠sica entre bridge e interface:
```bash
ip link show br0
```

Sa√≠da esperada:
```
3: br0: <BROADCAST,MULTICAST,UP,LOWER_UP> ...
    bridge-slave enp8s0
```

Vamos validar endere√ßo IP e gateway:
```bash
ip -br addr show br0
ip route | grep default
```

Agora, o teste de conectividade:
```bash
ping -c3 1.1.1.1
ping -c3 deb.debian.org
```

### Verificar via bridge-utils (opcional):
```bash
sudo brctl show
```
Sa√≠da esperada:
```
bridge name bridge id        STP enabled interfaces
br0         8000.74563cf018b4 no          enp8s0
```

Se todos os testes retornarem resultados positivos, a bridge `br0` est√° ativa e totalmente operacional.

## REVERS√ÉO SIMPLESMENTE COM O NETWORK-MANAGER (se necess√°rio)
Para desfazer a bridge e voltar a usar a `enp8s0` diretamente, para dar inicio ao processo, vamos desativar a interface `br0`:
```bash
$ sudo nmcli con down br0 
Conex√£o ‚Äúbr0‚Äù desativada com sucesso (caminho D-Bus ativo: /org/freedesktop/NetworkManager/ActiveConnection/6)
```

Depois vamos apag√°-la:
```bash
$ sudo nmcli con delete br0 
A conex√£o ‚Äúbr0‚Äù (aa0748de-5a0d-4d45-b908-9e9f2c788465) foi exclu√≠da com sucesso.
```
Em seguida, remova apenas as conex√µes relacionadas √† bridge `br0`, evitando apagar todas as bridges do sistema, digamos por exemplo que haja uma bridge criada com o nome `br0-port-enp8s0`, ent√£o repetimos o processo:
O comando abaixo ir√° desativar a porta recem criada:
```bash
sudo nmcli con down br0-port-enp8s0
sudo nmcli con delete br0-port-enp8s0 
```

> Se seu desejo for apagar todas as conex√µes de tipo bridge-slave do NetworkManager:  
> nmcli -t -f NAME,TYPE con show | awk -F: '$2=="bridge-slave"{print $1}' | xargs -r -I{} sudo nmcli con delete "{}"  
> **IMPORTANTE**: Este comando apaga todos sem distin√ß√£o, s√≥ use se souber exatamente o que esta fazendo.

Vamos listar as conex√£o que temos com o nome da original `xxx`, execute:
```bash
$ nmcli con show | grep "Wired connection 1"
Wired connection 1     f35944fc-aec3-4d0e-9ded-76c199678b97  ethernet  enp8s0 
Wired connection 1     55f6aebb-2d5e-46a5-8562-560211ea3a11  ethernet  --     
Wired connection 1     23471efa-cdf7-4d97-9d90-c822445d7c96  ethernet  --     
```
Perceba que apenas a primeira tem um vinculo com `enp8s0`, as demais n√£o deveriam existir, vamos exclu√≠-las:
Excluindo a conex√£o com id `55f6aebb-2d5e-46a5-8562-560211ea3a11`:
```bash
$ sudo nmcli con delete 55f6aebb-2d5e-46a5-8562-560211ea3a11
A conex√£o ‚ÄúWired connection 1‚Äù (55f6aebb-2d5e-46a5-8562-560211ea3a11) foi exclu√≠da com sucesso.
```
Excluindo a conex√£o com id `23471efa-cdf7-4d97-9d90-c822445d7c96`:
```bash
$ sudo nmcli con delete 23471efa-cdf7-4d97-9d90-c822445d7c96
A conex√£o ‚ÄúWired connection 1‚Äù (23471efa-cdf7-4d97-9d90-c822445d7c96) foi exclu√≠da com sucesso.
```


Vinculamos um nome de conex√£o `Wired connection 1` a interface `enp8s0`:
```bash
$ sudo nmcli con add type ethernet ifname enp8s0 con-name "Wired connection 1" ipv4.method auto
A conex√£o ‚Äúenp8s0‚Äù (55f6aebb-2d5e-46a5-8562-560211ea3a11) foi adicionada com sucesso.
```
Onde est√° `Wired connection 1` √© o nome original, mas voc√™ pode usar outro nome como `conexao1` para ficar mais simples.

E finalizamos com a ativa√ß√£o da interface `enp8s0`:
```bash
sudo nmcli con up enp8s0
Conex√£o ativada com sucesso (caminho D-Bus ativo: /org/freedesktop/NetworkManager/ActiveConnection/11)
```

## RESTAURA√á√ÉO BACKUP DA CONFIGURA√á√ÉO DE REDE
Se est√° lendo isso √© porque algo deu muito errado e revers√£o usando o NETWORK-MANAGER n√£o funcionou e agora precisa voltar a configura√ß√£o de rede original, n√£o √© mesmo?
Sem problemas, foi por isso que fizemos o backup antes de dar inicio aos procedimentos.  

Primeiro vamos apontar a variavel para a localiza√ß√£o de seus backups:  
```bash
export BKP=~/net-backups
```

Depois liste todos os seus backups e escoha o que for mais apropriado:  
```bash
$ ls -1 $BKP/
netcfg-2025-10-22_165719.tgz
netcfg-bridge-2025-10-23_165719.tgz
```

Determinado qual o arquivo de backup desejado, execute:
```bash
sudo tar -C / -xzf $BKP/netcfg-bridge-2025-10-23_165719.tgz
```

Os arquivos de configura√ß√£o ser√£o substituidos pelo backup, por√©m o gerenciador que os controla precisa ser reiniciado:    
```bash
sudo systemctl restart NetworkManager 
```

Para confirmar que a rede foi restaurada ao original, execute:
```bash
nmcli general status
nmcli con show 
ip -br a 
```
E compare seus resultados com o que havia no backup lendo o arquivo `netcfg-bridge-2025-10-23_165719.tgz.txt`.  
Se os resultados dos comandos acima deram baterem com os resultados do arquivo `netcfg-bridge-2025-10-23_165719.tgz.txt`, ent√£o voc√™ restaurou sua rede com sucesso.  

## CONCLUS√ÉO

Ao concluir este guia, voc√™ criou uma **bridge de rede funcional (`br0`)** totalmente integrada ao **NetworkManager**, permitindo que suas **m√°quinas virtuais ou containers** utilizem a mesma rede f√≠sica do host.  
Esse m√©todo garante que cada VM possa obter **endere√ßos IP reais da sua LAN**, facilitando comunica√ß√µes diretas, compartilhamento de arquivos, e acesso a servi√ßos como se fossem m√°quinas f√≠sicas.

Voc√™ tamb√©m aprendeu a:
- Fazer **backup das configura√ß√µes de rede** antes de qualquer modifica√ß√£o;
- Criar e vincular uma **interface f√≠sica (`enp8s0`)** √† bridge;
- Usar tanto **DHCP quanto IP est√°tico** na `br0`;
- **Verificar o estado da bridge** e testar conectividade;
- **Reverter** as altera√ß√µes com seguran√ßa caso algo d√™ errado.

> üí° **Dica final:**  
> Mantenha o arquivo de backup em um local externo (como um pendrive ou pasta de rede).  
> Assim, caso perca a conectividade, ser√° mais f√°cil restaurar sua configura√ß√£o original.

Com a bridge configurada corretamente, seu ambiente est√° pronto para hospedar **m√°quinas virtuais com desempenho de rede real**, ideal para testes de servidores, clusters e laborat√≥rios de virtualiza√ß√£o.  
Agora voc√™ pode seguir adiante e integrar a `br0` em suas VMs pelo **virt-manager**, **virsh** ou **QEMU** diretamente.
